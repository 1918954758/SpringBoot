<资源> - [静态资源地址1234](https://wws.lanzous.com/b01c2x0xc)

### 1. 登录页
- IndexController.java
    - login()
- login.html

```java
@Controller
public class IndexController {

    @GetMapping({"/", "/login"})
    public String login() {
        return "login";
    }
}
```
- 请求 / 或者 /login，跳转到login.html页面

### 2. 跳转主页
- IndexController.java
    - index()
- login.html
    - form表单提交
        - 调用 index() 方法
- index() 方法会重定向到 indexPage()

```html
@Controller
public class IndexController {

    /*
     * 主页
     */
    @PostMapping("/index")
    public String index(User user, HttpSession session, Model model) {
        if (Validate.validatelogin(session, user, model)) {
            // 防止表单重复提交
            return "redirect:/main.html";
        } else {
            return "login";
        }

    }

    // 刷新页面执行该方法，而不是重复提交POST，调用/index请求
    @GetMapping("/main.html")
    public String indexPage() {
        return "index";
    }
}
```

```html
login.html
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="ThemeBucket">
    <link rel="shortcut icon" href="#" type="image/png">
    <title>Login</title>
    <link href="css/style.css" rel="stylesheet">
    <link href="css/style-responsive.css" rel="stylesheet">
</head>
<body class="login-body">
<div class="container">

    <form class="form-signin" action="index.html" method="post" th:action="@{index}">
        <div class="form-signin-heading text-center">
            <h1 class="sign-title">Sign In</h1>
            <img src="images/login-logo.png" alt=""/>
        </div>
        <div class="login-wrap">
            <label style="color:red" th:text="${msg}">登录</label>
            <input type="userName" name="userName" class="form-control" placeholder="UserName" autofocus>
            <input type="passWord" name="passWord" class="form-control" placeholder="Password">
            <button class="btn btn-lg btn-login btn-block" type="submit">
                <i class="fa fa-check"></i>
            </button>
            <div class="registration">
                Not a member yet?
                <a class="" href="registration.html">
                    Signup
                </a>
            </div>
            <label class="checkbox">
                <input type="checkbox" value="remember-me"> Remember me
                <span class="pull-right">
                    <a data-toggle="modal" href="#myModal"> Forgot Password?</a>
                </span>
            </label>

        </div>
        <!-- Modal -->
        <div aria-hidden="true" aria-labelledby="myModalLabel" role="dialog" tabindex="-1" id="myModal"
             class="modal fade">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                        <h4 class="modal-title">Forgot Password ?</h4>
                    </div>
                    <div class="modal-body">
                        <p>Enter your e-mail address below to reset your password.</p>
                        <input type="text" name="email" placeholder="Email" autocomplete="off"
                               class="form-control placeholder-no-fix">
                    </div>
                    <div class="modal-footer">
                        <button data-dismiss="modal" class="btn btn-default" type="button">Cancel</button>
                        <button class="btn btn-primary" type="button">Submit</button>
                    </div>
                </div>
            </div>
        </div>
        <!-- modal -->
    </form>
</div>
<!-- Placed js at the end of the document so the pages load faster -->
<!-- Placed js at the end of the document so the pages load faster -->
<script src="js/jquery-1.10.2.min.js"></script>
<script src="js/bootstrap.min.js"></script>
<script src="js/modernizr.min.js"></script>
</body>
</html>
```

### 3. 登录校验用户名密码
- 校验用户名密码
- 将校验通过的用户名和密码放到请求域中
- 替换标签中的默认值

```html
th:text = "${msg}"
```

- 替换文本域中的内容

```html
[[${session.loginUser.userName}]]
<!-- 该方法可以将登录用户的名称添加到主页右上角 -->
```

[image-公共页面抽取](../image/https://www.bilibili.com/video/BV19K4y1L7MT?p=45&spm_id_from=pageDriver)

- 公共页面抽取（对于公共的内容只需修改一次就可，不需要重复修改多个页面）
    - 将多个页面的公共部分抽取到一个页面中，然后使用属性引入即可
- Thymeleaf
    - footer  - 公共页面的名称（templates/footer.html - templeats/*.html）
    - 1)
    - th:fragment="cpoy"
```html
        - <div th:insert="footer :: copy"></div>   (<div th:insert="~{footer :: copy}"></div>)
        - <div th:replace="footer :: copy"></div>   (<div th:replace="~{footer :: copy}"></div>)
        - <div th:include="footer :: copy"></div>   (<div th:include="~{footer :: copy}"></div>)
```
    - 2)
    - id="cpoy"
```html
        - <div th:insert="footer :: #copy"></div>   (<div th:insert="~{footer :: #copy}"></div>)
        - <div th:replace="footer :: #copy"></div>   (<div th:replace="~{footer :: #copy}"></div>)
        - <div th:include="footer :: #copy"></div>   (<div th:include="~{footer :: #copy}"></div>)
```

- 举例区别 th:insert & th:replace & th:include
```html
templates/footer.html
<footer th:fragment="copy">
  &copy; 2011 The Good Thymes Virtual Grocery
</footer>


<div th:insert="footer :: copy"></div>
    插入结果：
    > <div>
    >     <footer>
    >         &copy; 2011 The Good Thymes Virtual Grocery
    >     </footer>
    > </div>
<div th:replace="footer :: copy"></div>
    插入结果：
    > <footer>
    >     &copy; 2011 The Good Thymes Virtual Grocery
    > </footer>
<div th:include="footer :: copy"></div>
    插入结果：
    > <div>
    >     &copy; 2011 The Good Thymes Virtual Grocery
    > </div>
```

- 将 *-table.html页面的公共部分抽取到 templates/common/commons.html中
- 编写 *-table.html对应的tableController.java

[Thymeleaf引入页面官方文档](https://www.thymeleaf.org/doc/tutorials/3.0/usingthymeleaf.html#template-layout)

- 抽取index.html页面的公共部分 commonLinks commonLeftMenu commonHeader & commonScript
- 可以在源代码里面查看抽取部分是否正确引入

- 使用Thymeleaf覆盖HTML的src属性
    - src="js/xxx/xxx.js" --> th:src="@{/js/xxx/xxx.js}"
```html
<div th:fragment="commonScript">
        <!-- Placed js at the end of the document so the pages load faster -->
        <script src="js/jquery-1.10.2.min.js" th:src="@{/js/jquery-1.10.2.min.js}"></script>
        <script src="js/jquery-ui-1.9.2.custom.min.js" th:src="@{/js/jquery-ui-1.9.2.custom.min.js}"></script>
        <script src="js/jquery-migrate-1.2.1.min.js" th:src="@{/js/jquery-migrate-1.2.1.min.js}"></script>
        <script src="js/bootstrap.min.js" th:src="@{/js/bootstrap.min.js}"></script>
        <script src="js/modernizr.min.js" th:src="@{/js/modernizr.min.js}"></script>
        <script src="js/jquery.nicescroll.js" th:src="@{/js/jquery.nicescroll.js}"></script>
    </div>
    <div th:fragment="commonScript4AllPages">
        <!--common scripts for all pages-->
        <script src="js/scripts.js" th:src="@{/js/scripts.js}"></script>
    </div>
```

- 页面中发送get请求
- 使用href属性，使用Thrmeleaf的th:href覆盖href，跳转连接属性
```html
<!-- commons.html -->
<ul class="sub-menu-list">
  <li><a href="basic_table.html" th:href="@{/basic_table}"> Basic Table</a></li>
  <li><a href="dynamic_table.html" th:href="@{/dynamic_table}"> Advanced Table</a></li>
  <li><a href="responsive_table.html" th:href="@{/responsive_table}"> Responsive Table</a></li>
  <li><a href="editable_table.html" th:href="@{/editable_table}"> Edit Table</a></li>
</ul>

th:href="@{/basic_table}"  表示访问当前项目下的目录 basic_table
```
- 修改随时返回主页
- Dashboard
```html
common/commons.html
<li><a href="../index.html" th:href="@{/main.html}"><i class="fa fa-home"></i> <span>Dashboard</span></a></li>
```

- 修改登录用户名称显示
```html
<li>
    <a href="#" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
        <img src="images/photos/user-avatar.png" alt="" />
        [[${session.loginUser.userName}]]
        <span class="caret"></span>
    </a>
    <ul class="dropdown-menu dropdown-menu-usermenu pull-right">
        <li><a href="#"><i class="fa fa-user"></i>  Profile</a></li>
        <li><a href="#"><i class="fa fa-cog"></i>  Settings</a></li>
        <li><a href="#"><i class="fa fa-sign-out"></i> Log Out</a></li>
    </ul>
</li>
```

- 修改登出功能
```html
<ul class="dropdown-menu dropdown-menu-usermenu pull-right">
    <li><a href="#"><i class="fa fa-user"></i>  Profile</a></li>
    <li><a href="#"><i class="fa fa-cog"></i>  Settings</a></li>
    <li><a href="#" th:href="@{/}"><i class="fa fa-sign-out"></i> Log Out</a></li>
</ul>
```

- 给表格动态添加数据
- 准备数据
```java
@Data
@AllArgsConstructor
@NoArgsConstructor
@ToString
public class DataTest_01 {
    private String dataName;
    private String dataNum;
}

@Controller
public class TableController {
  @GetMapping("/dynamic_table")
  public String dynamic_table(Model model) {
    List<DataTest_01> dataTest_01s = Arrays.asList(new DataTest_01("aaa", "12"),
            new DataTest_01("bbb", "13"),
            new DataTest_01("ccc", "14"),
            new DataTest_01("ddd", "15"));
    model.addAttribute("dataTest_01s", dataTest_01s);
    return "table/dynamic_table";
  }
}
```
- 获取数据
```html
<table class="display table table-bordered" id="hidden-table-info">
  <thead>
    <tr>
      <th>#</th>
      <th>names</th>
      <th>nums</th>
    </tr>
  </thead>
  <tbody>
    <tr class="gradeX" th:each="dataTest_01:${dataTest_01s}">
      <td></td>
      <td th:text="${dataTest_01.getDataName()}"></td>
      <td>[[${dataTest_01.getDataNum()}]]</td>
    </tr>
  </tbody>
</table>
```
- 说明
  - th:each="dataTest_01:${dataTest_01s}" - 遍历集合 dataTest_01s，拿到每一个元素 dataTest_01
  - th:text="${dataTest_01.getDataName()}" - th:text属性获取值
  - [[${dataTest_01.getDataNum()}]] - 行内获取值方法
  - <td th:text="${dataTest_01.getDataNum()}"></td> 和 <td>[[${dataTest_01.getDataNum()}]]</td> 等价

### 4. 视图解析原理
> 探究三种返回类型
  > return "forward:/xxxx"; 
  > return "redirect:/xxxx";
  > return "xxxx"; 

- 目标方法处理过程中，所有的数据都会被放在MedelAndViewContainer里面
```java
public class ViewNameMethodReturnValueHandler implements HandlerMethodReturnValueHandler {
  public void handleReturnValue(@Nullable Object returnValue, MethodParameter returnType, ModelAndViewContainer mavContainer, NativeWebRequest webRequest) throws Exception {
    if (returnValue instanceof CharSequence) {
      // viewName 就是Controller方法中 return 的内容；如，return "redirect:/index"; viewName = redirect:/index
      String viewName = returnValue.toString();
      mavContainer.setViewName(viewName);
      if (this.isRedirectViewName(viewName)) {
        mavContainer.setRedirectModelScenario(true);
      }
    } else if (returnValue != null) {
      throw new UnsupportedOperationException("Unexpected return type: " + returnType.getParameterType().getName() + " in method: " + returnType.getMethod());
    }
  }
}
```
- 方法的参数是一个自定义对象（自定义参数的值是从请求中确定的），底层也会把自定义类型的参数放在ModelAndViewController中
- 任何目标方法，只要执行完成，都会返回一个ModelAndView对象
- 处理派发结果，（此时目标方法执行完成了，也生成了ModelAndView对象，是要对ModelAndView对象进行处理了）
```java
class DispatcherServlet {
  protected void doDispatch(HttpServletRequest request, HttpServletResponse response) throws Exception {
    processDispatchResult(processedRequest, response, mappedHandler, mv, dispatchException);
  }
}
```
- 渲染视图 render(mv, request, response);
  - 根据ModelAndView得到视图名进而得到View对象（View对象很关键，是个接口，里面定义了render()方法，可以实现将返回值渲染到页面）
    - return "forward:/xxxx"
      - mv = ha.handle(processedRequest, response, mappedHandler.getHandler());
      - ViewNameMethodReturnValueHandler.java
      - (PatternMatchUtils.simpleMatch(this.redirectPatterns, viewName) || viewName.startsWith("redirect:"));
    - return "redirect:/xxxx"
      - RedirectView.java
      - sendRedirect(request, response, targetUrl, this.http10Compatible);
      - response.sendRedirect(encodedURL);
      - response.sendRedirect(location);
    - return "xxxx"
      - ThymeleafView.java
      - response.getWriter()
      - writer.flush();




[拦截器-登陆资源检查与静态资源放行](https://www.bilibili.com/video/BV19K4y1L7MT?p=48&spm_id_from=pageDriver)